<!doctype html> 

<html>
<head>
    <title>Labyrinthe</title>
    
    <style>
        body {
            background-image: url("/Assets/Dungeon_wall_2.jpg");
            margin: 0px;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(7,150px);
            grid-template-rows: repeat(7,100x);    
            justify-content: center;
            align-items: center;
        }
        .labyr {
            grid-column: 1/6;
            grid-row: 1/6;
        }
        .haut {
            grid-column: 6;
            grid-row: 2;
            border-radius: 10px;
            margin: 20%;
        }
        .gauche {
            grid-column: 5;
            grid-row: 3;
            border-radius: 10px;
            margin: 20%;
        }
        .droite {
            grid-column: 7;
            grid-row: 3;
            border-radius: 10px;
            margin: 20%;
        }
        .bas {
            grid-column: 6;
            grid-row: 4;
            border-radius: 10px;
            margin: 20%;
        }
        .go {
            grid-column: 6;
            grid-row: 3;
            border-radius: 10px;
            
        }
        .timing {
            grid-column: 6;
            grid-row: 1;
            font-size: 20px;
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            border: solid 1px purple;
            justify-content: center;
            align-items: center;
            display: flex;
        }
        .nb-pas {
            text-align: center;
            grid-row: 1;
            grid-column: 7;
            font-size: auto;
        }
        .skeleton {
            display: grid;
            grid-template-columns: repeat(10,10%);
            grid-template-rows: 50px;
            margin-top: 10%;
        }
        .spooky1 {
            grid-column: 1;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky2 {
            grid-column: 2;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky3 {
            grid-column: 3;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky4 {
            grid-column: 4;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky4 {
            grid-column: 4;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky5 {
            grid-column: 5;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky6 {
            grid-column: 6;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky7 {
            grid-column: 7;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky8 {
            grid-column: 8;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky9 {
            grid-column: 9;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        .spooky10 {
            grid-column: 10;
            grid-row: 1;
            background-image: url("/Assets/d921zh2-fb75efff-22aa-4fd7-a1d2-0e2ce954e269.gif");
            background-size: contain;
        }
        tr {
            display: flex;
        }
        td {
            display:block
        }
        img{
            box-sizing: content-box;
            background-color: green;
        }
        .b:hover img, .f:hover img{
            filter:hue-rotate(325deg)
        }
        .valid:hover img{
            filter:hue-rotate(45deg)

        }
        .p:hover img{
            filter:hue-rotate(180deg)
        }
    </style>
</head>
    <body>
        <main class="container">
            <div id="laby" class="labyr">
    
            </div>
        <input class="go" type="button" value="GO" onclick="init()">


        <!-- ajouter vos boutons de déplacement ici -->
        <button class="haut" onclick="moveCharacter('top')">Haut</button>
        <button class="gauche" onclick="moveCharacter('left')">Gauche</button>
        <button class="droite" onclick="moveCharacter('right')">Droite</button>
        <button class="bas" onclick="moveCharacter('bottom')">Bas</button>

        <p id="timer" class="timing">00:00</p>
        <p id="nb-pas" class="nb-pas"></p>
        </main>
        <footer class="skeleton">
            <div class="spooky1"></div>
            <div class="spooky2"></div>
            <div class="spooky3"></div>
            <div class="spooky4"></div>
            <div class="spooky5"></div>
            <div class="spooky6"></div>
            <div class="spooky7"></div>
            <div class="spooky8"></div>
            <div class="spooky9"></div>
            <div class="spooky10"></div>
        </footer>
</body>
<script language="JavaScript">
    const m='m'; //représente un mur
    const p='p'; //représente le personnage
    const b='b'; //représente le chemin
    const f="f"; //représente le trophée 

    const moveKeys = {
        38 : "top",
        37 : "left",
        40 : "bottom",
        39 : "right"
    };

    var chrono;
    var gameOn = false;

    xperso=1; //position initial du personnage sur l'axe X
    yperso=1; //postition initial du personnage sur l'axe Y
    //tableau à double entrée représentant votre labyrinthe, vous pouvez le modifier pour comprendre le fonctionnement
    var laby = [[m,m,m,m,m,m,m,m,m,m],
                [m,p,m,b,b,b,b,b,b,m],
                [m,b,b,b,m,m,m,m,b,m],
                [m,b,m,b,b,b,b,m,b,m],
                [m,b,m,m,b,m,b,m,m,m],
                [m,b,b,b,b,m,b,b,b,f],
                [m,m,m,m,m,m,m,m,m,m]];
    var nbPas;
    var temps ;

    function init () {
        try {
            clearInterval(chrono)
        } catch {}
        nbPas = 0;
        timerElement.innerText = `00:00`
        nbPasElement.innerText = ""
        temps = departMinutes * 60;
        laby = [[m,m,m,m,m,m,m,m,m,m],
                [m,p,m,b,b,b,b,b,b,m],
                [m,b,b,b,m,m,m,m,b,m],
                [m,b,m,b,b,b,b,m,b,m],
                [m,b,m,m,b,m,b,m,m,m],
                [m,b,b,b,b,m,b,b,b,f],
                [m,m,m,m,m,m,m,m,m,m]];
        afficheLaby(); 
        setTimer(); 
        listeners(getCasesPos())
        gameOn = true;

    }

    function afficheLaby() //ne rien modifier dans cette fonction
    {
        var leLaby=document.getElementById("laby");
        insertion="<table border=0 cellspacing=0 cellpadding=0>";
     
     
        for(i=0;i<7;i++)
        {
        insertion+="<tr>";
            for(j=0;j<10;j++)
            {
                if (laby[i][j]==m)
                {
                insertion+="<td class='m'>";
                insertion+="<img width='52'height='52' src='Assets/stonewall.png'>";
                insertion+="</td>";
                }
                if (laby[i][j]==p)
                {
                insertion+="<td class='p'>";
                insertion+="<img width='52' height='52' style='background-image:Assets/Ground.png' src='Assets/Heros.png'>";
                insertion+="</td>";
                }
                if (laby[i][j]==b)
                {
                insertion+="<td class='b'>";
                insertion+="<img width='52' height='52' src='Assets/Ground.png'>";
                insertion+="</td>";
                }
                if (laby[i][j]==f)
                {
                insertion+="<td class='f'>";
                insertion+="<img width='52' height='52' src='Assets/Trophy.png'>";
                insertion+="</td>";
                }
                 
            }
            insertion+="</tr>";

        }  
        insertion+="</table>";
        leLaby.innerHTML=insertion;
        
    }

    function getCasesPos () {
        let trList = Object.values(document.querySelectorAll("tr"));
        let tabResult = [];

        for (let i = 0; i < trList.length; i++) {
            let tdList = Object.values(trList[i].querySelectorAll("td"));
            let ligneResult = [];

            for (let j = 0; j < tdList.length; j++) {
                let objectInser = {HTMLObject : tdList[j], content : laby[i][j], x : j, y : i};
                ligneResult.push(objectInser)
            }

            tabResult.push(ligneResult)
        }

        return tabResult

    }

    function listeners (tab) {
        for (let i = 0; i < tab.length; i++) {
            for (let j = 0; j < tab[i].length; j++) {
                let currentCase = tab[i][j]

                let charPos = getCharPos();
                let xDiff = currentCase.x - charPos.x;
                let yDiff = currentCase.y - charPos.y;

                let direction;

                switch ([xDiff, yDiff].join('')){
                    case '10' :
                        direction = 'right'
                        if ((currentCase.content === 'b') || (currentCase.content === 'f')) {currentCase.HTMLObject.classList.add('valid')}
                        break;

                    case '-10' :
                        direction = 'left'
                        if ((currentCase.content === 'b') || (currentCase.content === 'f')) {currentCase.HTMLObject.classList.add('valid')}
                        break;

                    case '01' : 
                        direction = 'bottom'
                        if ((currentCase.content === 'b') || (currentCase.content === 'f')) {currentCase.HTMLObject.classList.add('valid')}
                        break;

                    case '0-1' : 
                        direction = 'top'
                        if ((currentCase.content === 'b') || (currentCase.content === 'f')) {currentCase.HTMLObject.classList.add('valid')}
                        break;
                        }
                if (direction) {   
                    currentCase.HTMLObject.addEventListener('click', () => {
                            moveCharacter(direction)
                        }
                    )
                }
            }
        }
    }

    const departMinutes = 0.001

    const timerElement = document.getElementById("timer")
    const nbPasElement = document.getElementById("nb-pas")

    function setTimer() {
        if (temps === 0.06) {
            chrono = setInterval(() => {
            temps = temps <= 0 ? 0 : temps + 1
            let minutes = parseInt(temps / 60, 10)
            let secondes = parseInt(temps % 60, 10)

            minutes = minutes < 10 ? "0" + minutes : minutes
            secondes = secondes < 10 ? "0" + secondes : secondes
            timerElement.innerText = `${minutes}:${secondes}`
            }, 1000)
        }
    }
    function getCharPos () {
        for (let ligne of laby) {
            if (ligne.includes(p)) {
                return {x : ligne.indexOf(p), y : laby.indexOf(ligne)};
            }
        }
    }

    function moveCharacter(direction) {
        if (gameOn === true) {
            let charPos = getCharPos();
            let destination;
            let destinationPos;
            switch (direction){
                case 'top' :
                    destinationPos = {y : charPos.y-1, x : charPos.x};
                    break;
                case 'left' :
                    destinationPos = {y : charPos.y, x : charPos.x-1};
                    break;
                case 'bottom' : 
                    destinationPos = {y : charPos.y+1, x : charPos.x};
                    break;
                case 'right' : 
                    destinationPos = {y : charPos.y, x : charPos.x+1};
                    break;
            }
            destination = laby[destinationPos.y][destinationPos.x]
            if (destination === b || destination === f) {
                laby[destinationPos.y][destinationPos.x] = p;
                laby[charPos.y][charPos.x] = b;
                nbPas += 1
            }
            if (destination === f) {
                gameOn = false
                clearInterval(chrono)
                nbPasElement.innerText = "Nombre de pas\n" + nbPas
            };  
            afficheLaby()
            listeners(getCasesPos())
        }
    }

    var keyPress = document.addEventListener('keydown', event => {
        if (event.keyCode in moveKeys) {
            moveCharacter(moveKeys[event.keyCode])
        } else {
            // compléter événement de connerie
        }
    })
</script>
</html>